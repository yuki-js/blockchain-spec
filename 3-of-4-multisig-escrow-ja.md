```
  層: アプリケーション
  タイトル: 3-of4　マルチシグネチャー・エスクロー
  作者: 青木 勇樹 <ayukiyhs at gmail.com>
  作成日: 2018-11-17
```

[English version](3-of-4-multisig-escrow.md)

## 要旨

本文書は2-of-3 マルチシグネチャー・エスクローを拡張し、利用者とプラットフォーム運営者が共に、より非中央集権的で応用がきく方法で資金を制御できるようにする方法を提案する。

## 動機

2-of-3　マルチシグネチャー・エスクローは、暗号通貨で何かを購入するとき、安全かつ有用な解決法である。
しかし、実運用上、プラットフォーム運営者は利用料を徴収したり、追加でルールを適用したいと考えるかもしれない。

この方式は2-of-3 マルチシグネチャー・エスクローを拡張する。利用者だけでなく運営者も資金を管理できるような方法を提供する。
これにより、例えば、運営者は利用者の資金の所有権を奪うことなく手数料を支払わせることができ、加えて、いくつかのルールを適用することもできる。

## 定義

* 売り手 - エスクロー・プラットフォーム上でオンラインショップを開いている。
* 買い手 - 売り手から何か商品を買おうとしている。
* 運営者 - エスクロー・プラットフォームを運営している個人もしくは組織。
* プラットフォーム・サーバー - 運営者によって運営され、利用者の注文を管理するオンライン状態のコンピュータ

それぞれがコンピュータ上で秘密鍵を所有している。

## 仕様

1. 買い手がエスクロー・プラットフォーム上で「購入」ボタンをクリックする。
2. 売り手と買い手の公開鍵を収集する。
3. 以下の公開鍵をもとに、3-of-4 マルチシグP2SH(SegWitを利用するならばP2WSH)アドレスを生成する。
  - 買い手
  - 売り手
  - プラットフォーム・サーバー
  - 運営者
4. 買い手は価格とプラットフォーム利用料を含めた金額をマルチシグアドレスに預け入れる。
5. 売り手は預け入れをブロックチェーン上で確認したのち、商品を買い手に送付する。
6. 買い手はプラットフォーム・サーバーに商品が到着したことを通知する。
7. プラットフォーム・サーバーはトランザクションを生成し署名する。
  * プラットフォーム・サーバーがもつ秘密鍵で署名されている。
  * 出力(vout)は売り手のアドレスと、プラットフォーム利用料プールである
8. 売り手と買い手はトランザクションに署名する。
9. トランザクションをブロードキャストする。

もし売り手が商品を送らない、もしくは、売り手と買い手が何らかの理由でトランザクションに署名できない場合、運営者は介入し、運営者の秘密鍵で取引を巻き戻すことができる。

たとえ、よく訓練された利用者がトランザクションを編集し、手数料の支払いを拒否しようとしたとしても無駄である。なぜなら既にプラットフォームサーバーが署名しているからである。
この仕組みによって、プラットフォームは利用料の支払いを義務付けることができる。これが2-of-3 マルチシグネチャー・エスクローとの大きな違いである。

この方式は、暗号通貨ウォレットアプリがあり、アプリがディープリンクAPIなどを用いて独立して署名することができるようなとき、有用だろう。

欠点は、売り手と買い手が運営をある程度信頼しなければいけないことである。もしサーバーがダウンしてしまったら、トランザクションは生成されないだろう。
しかし、運営者はマルチシグネチャーアドレスにある資金に売り手または買い手の同意なしに使用できないので、運営者が故意にサービスを停止させるといった行為をするメリットはない。(2-of-3の場合と同様）
そのため、この方式は、ほとんどの暗号通貨取引所のような完全に中央集権化されたエスクローサービスよりずっと安全であると結論づけられる。

## 実装

開発中

## 参考文献

[Add the draft of Deep Link Payment Protocol spec](https://github.com/bitcoincashorg/bitcoincash.org/pull/145)

## 謝辞

## 履歴

* 2018-11-22 Created Japanese version.
* 2018-11-22 Created repository and moved from gists
* 2018-11-20 Made public and moved to my gists.
* 2018-11-17 Initial

## コピーライト

Copyright (c) 2018 Yuki Aoki
All rights reserved
